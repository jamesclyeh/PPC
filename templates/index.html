<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<link rel="stylesheet" type="text/css" href="../static/index/view.css" media="all">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Prescription Modification</title>

<script>
  var prescriptions
  $(document).ready(function() {
    $("#tabs").tabs();
    $( ".datepicker" ).datepicker();
    eventcheck();

    $("#addpres").on("click",function(){
      var querystring = $('#addform input').serialize() + $('#addform select').serialize();

      $.ajax({
        type: "POST",
        url: "addPrescription",
        data: querystring,
        dataType: "json",
        success: (function(data) {
          alert("success");
        }),
        error: (function(xhr, status, errormsg) {
          console.log(xhr);
          console.log(status);
          $('#errormsg').text(errormsg);
        })
      });
    });

    $('#druglist').on('change', function() {
      var index = this.selectedIndex - 1;
      $('#update_med_name').val(prescriptions[index].drug);
    });

  });

  function objectify(data) {
    var array = {};
    for(key in data) {
      $.each(data[key], function(key,value) {
        array[key] = value;
      });
    }
    return(array);
  }
  function eventnotice(status,drug,remaining_dosage) {
    var texthtml = "<tr>";
    if(status == 'error') {
      texthtml += '<td><img class="icon" src="../static/images/error.png"/></td>' +
                  '<td>Prescription for ' + drug + ' is empty. Please refill immediately.</td>' +
                  '<td>insert time</td>';
    }
    else if(status == 'warning') {
      texthtml += '<td><img class="icon" src="../static/images/warning.png"/></td>' +
                  '<td>Prescription for ' + drug + ' is low, ' + remaining_dosage + ' more dosages left.</td>' +
                  '<td>insert time</td>';
    }
    texthtml += "</tr>";
    $('#event_table').append(texthtml);

  }
  function eventcheck() {
    $.ajax({
        type: "GET",
        url: "users/1/prescriptions",
        success: (function(data) {
          var prescriptions = objectify(data);
          for(key in prescriptions) {
            $.ajax({
                type: "GET",
                url: "prescriptions/" + prescriptions[key].id + "/inventory",
                success: (function(inventory) {
                  if((inventory - prescriptions[key].dosage) < 0) {
                    eventnotice('error', prescriptions[key].drug, '0');
                  }
                  else if((inventory - 3*prescriptions[key].dosage) < 0) {
                    eventnotice('warning', prescriptions[key].drug, inventory/prescriptions[key].dosage);
                  }
                }),
                error: (function(xhr, status, errormsg) {
                  console.log(xhr);
                  console.log(status);
                  $('#errormsg').text(status + " " + errormsg);
                })
            });    
          }
        }),
        error: (function(xhr, status, errormsg) {
          console.log(xhr);
          console.log(status);
          $('#errormsg').text(status + " " + errormsg);
        })
    });
    
  }

  function updatedruglist() {
    $.ajax({
        type: "GET",
        url: "users/1/prescriptions",
        success: (function(data) {
          prescriptions = objectify(data);
          $('#druglist').empty();
          $('#druglist').append('<option value="" disabled selected>Select a drug...</option>');
          for(key in prescriptions) {
            $('#druglist').append('<option value="' + prescriptions[key].drug + '">' + prescriptions[key].drug +'</option>');
          }
        }),
        error: (function(xhr, status, errormsg) {
          console.log(xhr);
          console.log(status);
          $('#errormsg').text(status + " " + errormsg);
        })
    });
  }

  function updateprescriptionlist() {
    $.ajax({
        type: "GET",
        url: "users/1/prescriptions",
        success: (function(data) {
          var array = objectify(data);
          $('#prescriptions').empty();
          for(key in array) {
            $('#prescriptions').append('<td>' + array[key].drug + '</td>' +
                                       '<td>' + array[key].dosage + '</td>' +
                                       '<td>' + '99' +'</td>' +
                                       '<td>' + array[key].start_date + '</td>');
          }
        }),
        error: (function(xhr, status, errormsg) {
          console.log(xhr);
          console.log(status);
          $('#errormsg').text(status + " " + errormsg);
        })
    });

  }

</script>
</head>
<body>
<div width="100%" id="banner">
  <h1 id ="username">Clarence Chow</h1>
</div>

<!-- Event Bulletin -->
<div id="event_bulletin">
  <div id="event_title">
    <h4 id="event_title_text">Event Bulletin</h4>
  </div>
  <table id="event_table">
  </table>
</div>

<!-- Error Messages -->
<div id="error box" align="center" width="60%">
  <p id="errormsg" style="color:red;margin:0;text-align:center;min-height:20px;"></p>
</div>

<div id="tabs">
 <ul>
   <li><a href="#tabs-1">Add New Prescription</a></li>
   <li><a href="#tabs-2" onclick="updatedruglist()">Update Existing Prescription</a></li>
   <li><a href="#tabs-3" onclick="updateprescriptionlist()">Prescription List</a></li>
 </ul>
 <div id="tabs-1">
    <form id="addform" method="get">
      <table class="formleft">
        <tr><td>Name of Medication: </td><td><input name="med_name" type="text" /><br/></td></tr>
        <tr><td colspan="2">Dosage: </td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;Quantity: </td><td><input name="dosage" type="text" /></td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;Frequency: </td><td><select name="consumption_interval">
            <option value="daily" selected="selected">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
          </select>
        </td></tr>
      </table>
      <table class="formright">
        <tr><td colspan="2">Schedule: </td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;Start Date: </td><td><input name="start_date" type="text" class="datepicker" /></td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;End Date: </td><td><input name="end_date" type="text" class="datepicker" /></td></tr>
      </table>
      <div style="clear:both;"><br/></div>
      <p style="text-align:right;"><input id="addpres" type="button" value="Add New Prescription" /></p>
    </form>
 </div>
 <div id="tabs-2">
    <p>Drug Name: <select id="druglist"></select><br/><br/></p>
    <form id="updateform" method="get">
      <table class="formleft">
        <tr><td>Name of Medication: </td><td><input id="update_med_name" name="med_name" type="text" /><br/></td></tr>
        <tr><td colspan="2">Dosage: </td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;Quantity: </td><td><input id="update_dosage" name="dosage" type="text" /></td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;Frequency: </td><td><select name="consumption_interval">
            <option value="daily" selected="selected">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Biweekly</option>
          </select>
        </td></tr>
      </table>
      <table class="formright">
        <tr><td colspan="2">Schedule: </td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;Start Date: </td><td><input id="update_start_date" class="datepicker" name="start_date" type="text" /></td></tr>
        <tr><td>&nbsp;&nbsp;&nbsp;End Date: </td><td><input id="update_end_date" class="datepicker" name="end_date" type="text" /></td></tr>
      </table>
      <div style="clear:both;"><br/></div>
      <p style="text-align:right;"><input id="updatepres" type="button" value="Update Prescription" /></p>
    </form>
  </div>
  <div id="tabs-3">
    <table id="prescription-list">
      <thead>
        <th>Drug Name</th>
        <th>Dosage</th>
        <th>Quantity Remaining</th>
        <th>Start Date</th>
      </thead>
      <tr id="prescriptions">
      </tr>
    </table>
  </div>
</div>

</body>
